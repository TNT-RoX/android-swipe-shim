<!DOCTYPE html>
<!--
	Proof of concept - Android Swipe Shim
-->	
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>Android-swipe-shim</title>
		<meta name="description" content="Android-swipe-shim exposes native swipe to WebView :)" />
		<meta name="author" content="Andrew Page/TNT-Rox" />
		<meta name="viewport" content="width=device-width; initial-scale=1.0" />
	</head>
	<style>
		._android_swipeable {
			display: block;
			position: relative;
			left: 90px;
			top: 90px;
			width: 500px;
			height: 500px;
			border: 1px solid black;
			background:#00F;
		}
		._android_swipe_container {
			width: 100%;
			height: 100%;
			display: block;
			position: absolute;
			top: 0;
			left: 0;
			overflow: scroll;
		}
		._android_swipe_container::-webkit-scrollbar {
			display: none;
		}
		._android_swipe_shim {
			width: 200%;
			height: 200%;
			display: block;
		}
		.loghold {
			width: 700px;
			height: 100px;
			overflow: scroll;
		}
	</style>
	<body>
		<div class="loghold">
			<div id="log"></div>
		</div>
		<div class="_android_swipeable" id="test"></div>

	</body>
	<script>
		var swipeUp = function() {
			document.getElementById('log').innerHTML += 'swipeUp<br/>';
		},
			swipeDown = function() {
			document.getElementById('log').innerHTML += 'swipeDown<br/>';
		},
			swipeLeft = function() {
			document.getElementById('log').innerHTML += 'swipeLeft<br/>';
		},
			swipeRight = function() {
			document.getElementById('log').innerHTML += 'swipeRight<br/>';
		};
		document.getElementById('test').addEventListener("swipeUp", swipeUp, false);
		document.getElementById('test').addEventListener("swipeUp", swipeDown, false);
		document.getElementById('test').addEventListener("swipeUp", swipeLeft, false);
		document.getElementById('test').addEventListener("swipeUp", swipeRight, false);
		//android swipe shim
		var _MIN_DISTANCE_THRESHOLD = 2;//Math.round(80 / window.devicePixelRatio);
		var _MAX_TIME_THRESHOLD = 400;

		var _android_scroll_elements = document.getElementsByClassName('_android_swipeable');
		var _android_swipe_container_elements = document.getElementsByClassName('_android_swipe_container');

		var Trigger = function(element,m) {
			var event = new CustomEvent(m, {
			 'detail' : 'elem.dataset.time'
			 });
			element.dispatchEvent(event);
		}
		//SETUP:
		for (var i = 0; i < _android_scroll_elements.length; i++) {
			var el = _android_scroll_elements[i];
			var _android_swipe_container = document.createElement('div');
			_android_swipe_container.setAttribute('class', '_android_swipe_container');
			var _android_swipe_shim = document.createElement('div');
			_android_swipe_shim.setAttribute('class', '_android_swipe_shim');
			_android_swipe_container.appendChild(_android_swipe_shim);
			el.insertBefore(_android_swipe_container, el.firstChild);
		}
		for (var i = 0; i < _android_swipe_container_elements.length; i++) {
			var _this = _android_swipe_container_elements[i];
			_this.scrollLeft = _this.firstElementChild.clientWidth / 4;
			_this.scrollTop = _this.firstElementChild.clientHeight / 4;
			_this.setAttribute('data-scrollLeftOffset', _this.scrollLeft);
			_this.setAttribute('data-scrollTopOffset', _this.scrollTop);
			_this.setAttribute('data-scrollLeftAccumulator', 0);
			_this.setAttribute('data-scrollTopAccumulator', 0);
			_this.setAttribute('data-scrollTimeAccumulator', 0);
			_this.setAttribute('data-scrollTime', Date.now());

			_this.onscroll = function(e) {
				var _top = parseInt(this.getAttribute('data-scrollTopOffset')) - this.scrollTop, _left = parseInt(this.getAttribute('data-scrollLeftOffset')) - this.scrollLeft, _topAccumulator = parseInt(this.getAttribute('data-scrollTopAccumulator')) + _top, _leftAccumulator = parseInt(this.getAttribute('data-scrollLeftAccumulator')) + _left;

				if ((_topAccumulator > _MIN_DISTANCE_THRESHOLD) || (_topAccumulator < (_MIN_DISTANCE_THRESHOLD * -1))) {
					if (_topAccumulator > _MIN_DISTANCE_THRESHOLD) {
						Trigger(this.parentNode,'swipeDown');
					} else {
						Trigger(this.parentNode,'swipeUp');
					}
					this.setAttribute('data-scrollTopAccumulator', 0);
					this.setAttribute('data-scrollLeftAccumulator', 0);
				} else if ((_leftAccumulator > _MIN_DISTANCE_THRESHOLD) || (_leftAccumulator < (_MIN_DISTANCE_THRESHOLD * -1))) {
					if (_leftAccumulator > _MIN_DISTANCE_THRESHOLD) {
						Trigger(this.parentNode,'swipeLeft');
					} else {
						Trigger(this.parentNode,'swipeRight');
					}
					this.setAttribute('data-scrollTopAccumulator', 0);
					this.setAttribute('data-scrollLeftAccumulator', 0);
				} else {
					this.setAttribute('data-scrollTopAccumulator', _topAccumulator);
					this.setAttribute('data-scrollLeftAccumulator', _leftAccumulator);
				}

				this.scrollLeft = this.getAttribute('data-scrollLeftOffset');
				this.scrollTop = this.getAttribute('data-scrollTopOffset');
			};
		}
	</script>
</html>
